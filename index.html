<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sisyphus' Ruin</title>
<style>
  :root {
    /* Default Colors (Cosmic) */
    --bg: #080014;
    --text: #fef8ff;
    --muted: #9e8fb2;
    --accent: #ff9e2c;   /* Gold/Orange - Ascent/Win */
    --accent-2: #ff00b8; /* Pink - Height bar accent */
    --accent-3: #00b7ff; /* Blue - Steady/Poise */
    --danger: #ff3333;   /* Red - Ruin/Storm */
    --success: #00ff9d;  /* Green - Summit */
    
    --card-bg-color: #0c0020; 
    --card-bg: rgba(12, 0, 32, 0.75);
    --card-border: rgba(255,255,255,0.08);
    --card-highlight: rgba(255,255,255,0.15);

    --bg-image: 
      radial-gradient(900px 700px at 50% -200px, rgba(255,0,200,.15), transparent 70%),
      radial-gradient(900px 700px at 50% 120%, rgba(0,200,255,.12), transparent 70%),
      linear-gradient(180deg,#0b0014 0%, #050010 100%);
  }

  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

  body {
    margin: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: var(--text);
    min-height: 100vh; 
    background-color: var(--bg);
    background-image: var(--bg-image);
    background-repeat: no-repeat; 
    background-size: cover;
    background-attachment: fixed;
    transition: background-color 0.5s ease, color 0.5s ease, background-image 0.5s ease;
    overflow-y: scroll;
  }
  
  .app{max-width:1100px;margin:0 auto;padding:4px}
  
  h1{
    text-align:center; font-size:18px; margin:4px 0 8px; letter-spacing:2px; font-weight: 800; text-transform: uppercase;
    background:linear-gradient(9deg,var(--accent),var(--text),var(--accent-3));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow: 0 2px 20px rgba(0,0,0,0.4); opacity: 0.9;
  }
  
  /* Grid Layout */
  .grid{display:grid;grid-template-columns:1fr 350px;gap:4px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  
  /* Card Styling */
  .card {
    background: var(--card-bg); 
    backdrop-filter: blur(12px); 
    padding: 8px; 
    border-radius: 6px; 
    border: 1px solid var(--card-border);
    border-top: 1px solid var(--card-highlight);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: background 0.5s ease, border-color 0.5s ease;
    margin-bottom: 4px;
    position: relative;
  }
  
  .card h2 { 
    font-size: 10px; 
    text-transform: uppercase; 
    letter-spacing: 1px; 
    font-weight: 700;
    color: var(--muted);
    margin: 0 0 6px; 
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 4px;
  }

  .btn{
    appearance:none; border:none; color:var(--text); border-radius:4px;
    padding:4px 8px; cursor:pointer; font-weight:600; letter-spacing:.3px;
    transition: all .15s ease; 
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
    background: rgba(255,255,255,0.03);
    font-size: 10px;
  }
  .btn:hover{background:rgba(255,255,255,0.08); box-shadow:inset 0 0 0 1px rgba(255,255,255,.2); color: #fff;}
  .btn:active{transform:translateY(1px); background:rgba(255,255,255,0.02);}
  .btn:focus{outline:none; box-shadow:inset 0 0 0 1px var(--accent);}
  
  .btn:disabled {
    opacity: 0.5; cursor: not-allowed; background: #111 !important;
    color: #555 !important; transform: none !important; box-shadow: none !important;
  }
  
  .checkbox-wrapper {
    display: flex; align-items: center; gap: 6px; padding: 0 4px; width: auto; 
    height: 24px; cursor: pointer; user-select: none; opacity: 0.8; transition: opacity 0.2s;
  }
  .checkbox-wrapper:hover { opacity: 1; }
  .checkbox-wrapper input[type="checkbox"] {
    appearance: none; width: 12px; height: 12px; background: rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.2); border-radius: 3px; cursor: pointer;
    display: grid; place-content: center; margin: 0;
  }
  .checkbox-wrapper input[type="checkbox"]::before {
    content: ""; width: 6px; height: 6px; background: var(--accent);
    transform: scale(0); transition: 0.1s transform; border-radius: 1px;
  }
  .checkbox-wrapper input[type="checkbox"]:checked::before { transform: scale(1); }
  .checkbox-wrapper input[type="checkbox"]:checked { border-color: var(--accent); }
  .checkbox-wrapper label { cursor: pointer; color: var(--text); width: auto; font-size: 10px; font-weight: 500; }

  .docked-control {
    position: sticky; top: 0; z-index: 1000;
    background: rgba(8,0,20, 0.9); backdrop-filter: blur(10px);
    margin: -4px -4px 4px -4px; padding: 4px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex; justify-content: center;
  }

  .btn.big{
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    width:100%; padding:4px; margin-bottom:0; 
    background: linear-gradient(135deg, var(--accent), var(--accent-3)); 
    color: #000; font-weight:800; max-width: 600px; min-height: 44px; 
    line-height: 1.1; transition: all 0.2s ease; border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    border-radius: 4px;
  }
  .btn.big:hover{ filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 15px rgba(var(--accent),0.4); }
  .btn.big:active{ transform: translateY(1px); }
  
  .btn.big.outcome-win:disabled { background: var(--accent) !important; color: var(--bg) !important; opacity: 1 !important; }
  .btn.big.outcome-neu:disabled { background: var(--accent-3) !important; color: var(--bg) !important; opacity: 1 !important; }
  .btn.big.outcome-loss:disabled { background: var(--danger) !important; color: #ffffff !important; opacity: 1 !important; }
  
  .btn-main-text { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

  label{width:90px;font-size:9px;color:var(--muted); line-height: 1.1;}
  
  input[type="number"],select,input[type="text"]{
    background:rgba(0,0,0,0.4); color:var(--text); border:1px solid rgba(255,255,255,0.05); border-radius:3px;
    padding:2px 4px; width: 45px; font-size: 10px; font-family: monospace;
    transition: border-color 0.2s;
  }
  input[type="number"]:focus,select:focus,input[type="text"]:focus {
      outline: none; border-color: var(--accent); background: rgba(0,0,0,0.6);
  }
  
  input[type="color"] {
    -webkit-appearance: none; border: none; width: 100%; height: 24px; padding: 0; overflow: hidden; border-radius: 2px; background: none; cursor: pointer;
  }
  input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
  input[type="color"]::-webkit-color-swatch { border: none; border-radius: 2px; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2); }
  
  select#speed { width: auto; }
  input#nRolls { width: 40px; }

  .desc{font-size:9px;opacity:.6;color:var(--muted);margin:-2px 0 3px; display:block; line-height:1.2;}
  .row{display:flex;gap:4px;align-items:center;flex-wrap:wrap; margin-bottom: 2px;}
  .bar{
    height:6px; background:rgba(255,255,255,.06); border-radius:2px;
    overflow:hidden; margin:2px 0; border:1px solid rgba(255,255,255,.05);
  }
  .bar>div{height:100%}
  .bar .win{background:var(--accent)}
  .bar .neu{background:var(--accent-3)}
  .bar .loss{background:var(--danger)}

  .kpos-track,.lpos-track{
    height:5px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.05);
    border-radius:2px; overflow:hidden;
  }
  
  .kpos-fill, .lpos-fill {
    height: 100%; width: 0%; transition: width 0s linear; will-change: width, background-position;
  }
  .kpos-fill { background: linear-gradient(90deg, var(--accent), var(--accent-2)); }
  .lpos-fill { background: linear-gradient(90deg, var(--accent-3), var(--success)); }

  @keyframes barberpole { 0% { background-position: 0 0; } 100% { background-position: 20px 0; } }

  .kpos-fill.active-motion, .lpos-fill.active-motion {
    animation: barberpole 0.5s linear infinite;
    filter: brightness(1.2);
    background-size: 10px 10px, 100% 100%;
    background-image: 
      linear-gradient(45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent),
      linear-gradient(90deg, var(--accent), var(--accent-2));
  }
  .lpos-fill.active-motion {
      background-image: 
      linear-gradient(45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent),
      linear-gradient(90deg, var(--accent-3), var(--success));
  }
  .kpos-fill.reverse-motion, .lpos-fill.reverse-motion {
    animation-direction: reverse; 
    background-image: 
      linear-gradient(45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent),
      linear-gradient(90deg, var(--danger), var(--danger)) !important;
  }
  
  .tiny{font-size:10px;opacity:.7;color:var(--muted)}
  .mono{font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', monospace; letter-spacing: -0.5px;}
  .small{font-size:10px;}

  .recent.win #recent-outcome{color:var(--accent); text-shadow:0 0 15px rgba(var(--accent), 0.5);}
  .recent.neu #recent-outcome{color:var(--accent-3); text-shadow:0 0 15px rgba(var(--accent-3), 0.5);}
  .recent.loss #recent-outcome{color:var(--danger); text-shadow:0 0 15px rgba(var(--danger), 0.5);}
  
  .cycle-entry {
    font-family: monospace; font-size: 9px; border-radius: 2px; 
    border-left: 2px solid rgba(255,255,255,.05); padding: 2px 4px; 
    margin-bottom: 2px; background: rgba(0,0,0,0.2); 
    white-space: pre-wrap; word-break: break-word;
    display: flex; flex-direction: column; gap: 1px;
    transition: background 0.2s;
  }
  .cycle-entry:hover { background: rgba(255,255,255,0.05); }
  .cycle-entry.loss { border-color: var(--danger); }
  .cycle-entry.top { border-color: var(--accent); background: rgba(255,255,255,0.05); }
  .cycle-entry.active { border-color: var(--text); background: rgba(255,255,255,0.02); }

  .cycle-entry-top-row { display: flex; justify-content: space-between; align-items: baseline; font-weight: 600; opacity: 0.9; line-height: 1.1; }
  .cycle-id { color: var(--accent-3); margin-right: 6px; }
  .cycle-meta { font-weight: 400; opacity: 0.65; font-size: 8px; }
  .cycle-entry-path { opacity: 0.5; font-size: 8px; line-height: 1; letter-spacing: 0.5px; margin-top: 1px; }

  .stats-grid {
    display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin-top: 4px;
    background: rgba(0,0,0,0.2); padding: 3px; border-radius: 3px;
  }
  .stat-box { display: flex; flex-direction: column; align-items: center; }
  .stat-label { font-size: 7px; opacity: 0.4; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-val { font-family: monospace; font-size: 9px; font-weight: 600; color: var(--accent-3); }

  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  .perf-indicator { position: fixed; bottom: 4px; right: 4px; background: rgba(0,0,0,0.8); padding: 2px 4px; border-radius: 3px; font-size: 9px; font-family: monospace; opacity: 0.3; pointer-events: none; }

  /* Modals */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center; }
  .modal.show { display: flex; }
  .modal-content { background: var(--bg); border: 1px solid var(--accent); padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; box-shadow: 0 0 50px rgba(0,0,0,0.9); position: relative; }
  .modal h3 { margin-top: 0; color: var(--accent); font-size: 18px; letter-spacing: 1px; text-transform: uppercase; }
  .modal kbd { background: rgba(255,255,255,0.1); padding: 1px 5px; border-radius: 3px; font-family: monospace; border: 1px solid rgba(255,255,255,0.2); font-size: 11px;}
  
  .welcome-list { margin: 10px 0; padding-left: 0; list-style: none; }
  .welcome-list li { margin-bottom: 8px; line-height: 1.4; font-size: 13px; opacity: 0.8; }
  .welcome-list strong { color: var(--accent-3); }

  .weather-status { font-weight: 800; letter-spacing: 1px; }
  .weather-good { color: var(--accent); text-shadow: 0 0 10px rgba(var(--accent),0.5); }
  .weather-ok { color: var(--accent-3); text-shadow: 0 0 10px rgba(var(--accent-3),0.5); }
  .weather-bad { color: var(--danger); text-shadow: 0 0 10px rgba(var(--danger),0.5); }

  #weather-card { position: relative; overflow: hidden; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
  #weather-content { position: relative; z-index: 2; margin-top: auto; }
  #chaosCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; opacity: 0.3; pointer-events: none; mix-blend-mode: screen; }

  .save-slots-container { margin: 4px 0; padding: 3px; background: rgba(0,0,0,0.2); border-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
  .slot-mode-switch { display: flex; gap: 2px; margin-bottom: 3px; }
  .slot-mode-btn { flex: 1; font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px; border: 1px solid transparent; opacity: 0.5; transition: all 0.2s ease; }
  .slot-mode-btn.active { opacity: 1; font-weight: 800; background: rgba(255,255,255,0.1); }
  .mode-save .slot-mode-btn[data-mode="save"] { background: var(--accent); color: var(--bg); }
  .mode-load .slot-mode-btn[data-mode="load"] { background: var(--accent-3); color: var(--bg); }

  .slot-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; }
  .slot-btn { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); border-radius: 3px; padding: 2px; font-family: monospace; font-size: 8px; color: var(--muted); cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 32px; text-align: center; }
  .slot-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
  .slot-btn.has-data { border-color: rgba(255,255,255,0.2); color: var(--text); background: rgba(255,255,255,0.05); }
  .slot-btn.empty { opacity: 0.4; font-style: italic; }
  .mode-save .slot-btn:hover { border-color: var(--accent); color: var(--accent); }
  .mode-load .slot-btn:hover { border-color: var(--accent-3); color: var(--accent-3); }
  .slot-label { font-weight: 800; font-size: 8px; margin-bottom: 0px; }
  .slot-info { font-size: 7px; line-height: 1; opacity: 0.8; }

  /* Accordion Styling */
  details { margin-bottom: 2px; background: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; border: 1px solid rgba(255,255,255,0.03); }
  details summary { cursor: pointer; padding: 2px 6px; user-select: none; outline: none; background: rgba(255,255,255,0.02); font-weight: 600; font-size: 10px; color: var(--muted); display: flex; align-items: center; }
  details summary:hover { color: var(--text); background: rgba(255,255,255,0.05); }
  details > summary { list-style: none; }
  details > summary::-webkit-details-marker { display: none; }
  details > summary::before { content: '▸'; display: inline-block; margin-right: 6px; font-size: 10px; color: var(--accent); transition: transform 0.1s; }
  details[open] > summary::before { transform: rotate(90deg); }
  
  details .details-content { padding: 4px 6px; border-top: 1px solid rgba(255,255,255,0.05); }
  .card details { margin-bottom: 2px; }

  /* Expanded Palette Grid */
  .palette-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 6px; }
  .palette-item { display: flex; flex-direction: column; align-items: center; gap: 2px; background:rgba(255,255,255,0.03); padding:3px; border-radius:3px; }
  .palette-label { font-size: 8px; opacity: 0.6; text-align: center; margin-top: 1px;}
  
  /* Reworked Palette Manager */
  .palette-manager { margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px; display:flex; flex-direction:column; gap:4px; }
  
  /* Utility for alignment */
  .flex-v-center { display: flex; align-items: center; }
  .space-between { justify-content: space-between; }
</style>
<link rel="icon" type="image/svg+xml" href="/sisyphus-icon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

</head>
<body>

<div role="status" aria-live="polite" aria-atomic="true" class="sr-only" id="aria-announcer"></div>

<div class="modal" id="help-modal" role="dialog" aria-labelledby="help-title">
  <div class="modal-content">
    <h3 id="help-title">Keyboard Shortcuts</h3>
    <dl>
      <dt><kbd>Space</kbd> or <kbd>Enter</kbd></dt>
      <dd>Roll once</dd>
      <dt><kbd>A</kbd></dt>
      <dd>Toggle auto-play</dd>
      <dt><kbd>R</kbd></dt>
      <dd>Reset game</dd>
      <dt><kbd>?</kbd></dt>
      <dd>Show/hide this help</dd>
      <dt><kbd>Esc</kbd></dt>
      <dd>Close this help</dd>
    </dl>
    <button class="btn" onclick="document.getElementById('help-modal').classList.remove('show')">Close</button>
  </div>
</div>

<div class="modal" id="welcome-modal" role="dialog" aria-labelledby="welcome-title">
  <div class="modal-content">
    <h3 id="welcome-title">Welcome to Sisyphus' Ruin</h3>
    <div class="tiny" style="margin-bottom:12px; opacity:0.7; font-style:italic">The struggle itself towards the heights is enough to fill a man's heart.</div>
    <ul class="welcome-list">
      <li><strong>1. Roll</strong> to push the stone.</li>
      <li><strong>2. Watch</strong> the outcome: <strong>Ascent</strong> gains height, <strong>Ruin</strong> resets you. <strong>Steady</strong> builds poise.</li>
      <li><strong>3. Endure:</strong> The atmosphere will distort time.</li>
    </ul>
    <button class="btn" style="width:100%" onclick="document.getElementById('welcome-modal').classList.remove('show'); localStorage.setItem('sisyphus_welcome_seen', 'true');">Begin</button>
  </div>
</div>

<div class="modal" id="summit-modal" role="dialog" aria-labelledby="summit-title">
  <div class="modal-content" style="border-color: var(--success); box-shadow: 0 0 50px rgba(0,255,157,0.2);">
    <h3 id="summit-title" style="color:var(--success); text-align:center; font-size:24px; margin-bottom:8px">The Summit</h3>
    <div class="tiny" style="text-align:center; margin-bottom:20px; font-style:italic; opacity:0.8">
      The stone rests. The air is still. For a moment, the struggle ceases.
    </div>
    
    <div style="background:rgba(255,255,255,0.05); padding:16px; border-radius:6px; margin-bottom:20px;">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <span style="opacity:0.7">Duration</span>
        <span class="mono" id="summit-duration" style="font-weight:bold">0s</span>
      </div>
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <span style="opacity:0.7">Total Steps</span>
        <span class="mono" id="summit-steps" style="font-weight:bold">0</span>
      </div>
      <div class="row" style="justify-content:space-between">
        <span style="opacity:0.7">Attempts</span>
        <span class="mono" id="summit-cycles" style="font-weight:bold">0</span>
      </div>
    </div>

    <div style="display:flex; gap:8px; flex-direction:column">
      <button class="btn big outcome-win" id="btn-summit-reset">
        BEGIN AGAIN
      </button>
      <button class="btn" id="btn-summit-close" style="background:transparent; border:1px solid rgba(255,255,255,0.2); opacity:0.8">
        Survey the mountain
      </button>
    </div>
  </div>
</div>

<div class="perf-indicator" id="perf-indicator"></div>

<template id="tpl-cycle-entry">
  <div class="cycle-entry">
    <div class="cycle-entry-top-row">
      <span class="cycle-main-text"></span>
      <span class="cycle-meta"></span>
    </div>
    <div class="cycle-entry-path"></div>
  </div>
</template>

<div class="app">
  <h1>Sisyphus' Ruin</h1>

  <div class="docked-control">
    <button class="btn big" id="roll1_big" aria-label="Roll the dice once" aria-keyshortcuts="Space Enter">
      <span class="btn-main-text" id="btn-roll-main">ROLL</span>
    </button>
  </div>

  <div class="grid">
    <div>
      <div class="card recent" id="recent-card" role="region" aria-label="Recent roll result">
        <div style="display:flex;flex-direction:column;gap:2px">
          <div id="recent-outcome" style="font-weight:900;letter-spacing:1px;font-size:20px; text-transform:uppercase">NO ROLLS</div>
        </div>
        
        <div class="recent-bars" style="margin-top:6px;">
          <div class="bar" style="display:flex; height:8px; overflow:hidden; margin-bottom:4px" role="progressbar">
            <div id="rbar-win" class="win" style="width:0%"></div>
            <div id="rbar-neu" class="neu" style="width:0%"></div>
            <div id="rbar-loss" class="loss" style="width:0%"></div>
          </div>
          <div class="row" style="justify-content:space-between; font-size:10px; opacity:0.8">
            <div>Ascent: <span class="mono" id="rpct-win">0.0%</span></div>
            <div>Steady: <span class="mono" id="rpct-neu">0.0%</span></div>
            <div>Ruin: <span class="mono" id="rpct-loss">0.0%</span></div>
          </div>
        </div>

        <div class="kpos" style="margin-top:6px">
          <div class="small" style="display:flex; justify-content:space-between; margin-bottom:2px">
            <span style="opacity:0.6; text-transform:uppercase; font-size:8px; font-weight:700">Height</span>
            <span id="kpos-text" class="mono">1 / 20</span>
          </div>
          <div class="kpos-track"><div id="kpos-fill" class="kpos-fill" style="width:0%"></div></div>
        </div>
        <div class="lpos" style="margin-top:4px">
            <div class="small" style="display:flex; justify-content:space-between; margin-bottom:2px">
                <span style="opacity:0.6; text-transform:uppercase; font-size:8px; font-weight:700">Poise</span>
                <span id="lpos-text" class="mono">0 / 20</span>
              </div>
          <div class="lpos-track"><div id="lpos-fill" class="lpos-fill" style="width:0%"></div></div>
        </div>
      </div>

      <div class="card" id="weather-card">
        <canvas id="chaosCanvas"></canvas>
        <h2 style="position: relative; z-index: 2;">Atmosphere</h2>
        <div id="weather-content">
          <div style="display:flex; justify-content:space-between; align-items:flex-end">
            <div>
              <div class="tiny" style="margin-bottom:1px">CONDITION</div>
              <div id="weather-status-main" style="font-size:14px; font-weight:800; letter-spacing:1px">CALIBRATING</div>
            </div>
            <div style="text-align:right">
              <div class="tiny" style="margin-bottom:1px">DILATION</div>
              <div id="weather-mod-val" class="mono" style="font-size:14px;">1.0x</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>History</h2>
        <div id="cycle-box" class="tiny" style="max-height: 120px; overflow-y: auto;"></div>
      </div>

      <div class="card"><h2>Run Stats</h2>
        <div style="margin-bottom:4px; font-size:9px; opacity:0.8; display:flex; justify-content:space-between;">
            <span>STEPS: <span class="mono" id="run-steps">0</span></span>
            <span>MAX: <span class="mono" id="max-k">1</span></span>
        </div>
        <div class="bar" style="display:flex; height:6px; overflow:hidden" role="progressbar" aria-label="Run Distribution">
          <div class="win" id="bar-win" style="width:0%"></div>
          <div class="neu" id="bar-neu" style="width:0%"></div>
          <div class="loss" id="bar-loss" style="width:0%"></div>
        </div>
        <div class="row" style="justify-content:space-between; font-size:9px; opacity:0.6; margin-top:2px">
          <div>Ascent: <span class="mono" id="c-win">0</span> (<span class="mono" id="r-win">0%</span>)</div>
          <div>Steady: <span class="mono" id="c-neu">0</span> (<span class="mono" id="r-neu">0%</span>)</div>
          <div>Ruin: <span class="mono" id="c-loss">0</span> (<span class="mono" id="r-loss">0%</span>)</div>
        </div>
        <div class="row tiny" style="margin-top:4px;justify-content:space-between; border-top:1px solid rgba(255,255,255,0.05); padding-top:2px">
          <div>TIME: <span class="mono" id="run-time">0s</span></div>
        </div>
      </div>
    </div>

    <div>
        <div class="card">
            <h2>The Burden</h2>
            <div class="tiny" style="line-height:1.4; opacity:0.9">
              The stone is bound for the summit (Height <span id="lbl-M-goal" style="font-weight:bold; color:var(--accent)">20</span>).
              <ul style="padding-left: 12px; margin: 4px 0;">
                  <li><strong>Steady:</strong> The stone holds fast. Poise accumulates.</li>
                  <li><strong>Ascent:</strong> The stone rises. Poise is shattered by the effort.</li>
                  <li><strong>Ruin:</strong> Gravity wins. Height resets.</li>
              </ul>
              <strong>Poise Mechanics:</strong> <br>
              Poise represents stability. As Poise increases, the probability of <strong>Ascent</strong> rises and the probability of <strong>Ruin</strong> falls. However, every Ascent consumes a significant amount of Poise, making subsequent rolls perilous.
              <br><br>
              <strong>Weather Mechanics:</strong> <br>
              The chaotic atmosphere affects the passage of time. <strong>Stormy</strong> conditions dilate time, increasing the cooldown between moves.
            </div>
        </div>

      <div class="card" id="params-container">
        <details>
            <summary>PARAMETERS</summary>
            
            <div class="details-content">
                <details id="submenu-system">
                  <summary>Main System</summary>
                  <div class="details-content">
                    <div class="row"><label for="M">M (Max Height)</label><input id="M" type="number" value="20"></div>
                    <div class="row"><label for="L">L (Max Poise)</label><input id="L" type="number" value="20"></div>
                    <div class="row"><label>w_min → w_max</label><input id="w_min" type="number" step="0.01" value="0.10"><input id="w_max" type="number" step="0.01" value="0.90"></div>
                    <div class="row"><label for="beta">β (Height ramp)</label><input id="beta" type="number" step="0.1" value="1.5"></div>
                    <div class="row"><label>ρ, γ (Poise boost)</label><input id="rho" type="number" step="0.05" value="0.6"><input id="gamma" type="number" step="0.1" value="1.5"></div>
                    <div class="row"><label>c_min → c_max</label><input id="c_min" type="number" step="0.01" value="0.03"><input id="c_max" type="number" step="0.01" value="0.10"></div>
                    <div class="row"><label for="alpha">α (Loss decay)</label><input id="alpha" type="number" step="0.1" value="0.3"></div>
                    <div class="row"><label>g_n, s_w</label><input id="g_n" type="number" value="1"><input id="s_w" type="number" value="20"></div>
                  </div>
                </details>

                <details id="submenu-weather">
                    <summary>Weather System</summary>
                    <div class="details-content">
                        <div class="row"><label for="chaos_dt">Dt (Chaos Step)</label><input id="chaos_dt" type="number" step="0.001" value="0.0025"></div>
                        <div class="row"><label for="chaos_intensity">Intensity</label><input id="chaos_intensity" type="number" step="0.1" value="1.0"></div>
                        <div class="row"><label for="max_delay">Max Delay (s)</label><input id="max_delay" type="number" step="0.1" value="45.0"></div>
                    </div>
                </details>

                <details id="submenu-theme">
                    <summary>Visual Theme</summary>
                    <div class="details-content">
                        <div class="row" style="margin-bottom: 4px;">
                            <label for="theme-select" style="color:var(--accent-3); width:auto; margin-right:8px;">Preset:</label>
                            <select id="theme-select" style="flex:1">
                                <option value="default">Cosmic (Default)</option>
                                <option value="magma">Sisyphus (Magma)</option>
                                <option value="terminal">Terminal (Matrix)</option>
                                <option value="paper">Academic (Light)</option>
                                <option value="ocean">Abyss (Deep Blue)</option>
                                <option value="custom">Custom (Below)</option>
                            </select>
                        </div>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.05); padding-top:4px; margin-top:4px;">
                            <div class="row" style="justify-content:space-between; margin-bottom:2px">
                                <span class="tiny" style="font-weight:bold; color:var(--accent)">Palette Tool</span>
                                <button class="btn" id="btn-random-palette" style="padding:1px 4px; font-size:8px;">Random OKLCH</button>
                            </div>
                            <div id="contrast-warning" style="display:none; background:rgba(255,100,0,0.2); border:1px solid var(--danger); border-radius:3px; padding:2px 4px; margin-bottom:2px; font-size:8px; color:var(--danger);">
                                ⚠️ <span id="contrast-warning-text">Low contrast</span>
                            </div>
                            <div class="palette-grid">
                                <div class="palette-item">
                                    <input type="color" id="picker-bg" value="#080014">
                                    <span class="palette-label">Bg</span>
                                </div>
                                <div class="palette-item">
                                    <input type="color" id="picker-text" value="#fef8ff">
                                    <span class="palette-label">Txt</span>
                                </div>
                                <div class="palette-item">
                                    <input type="color" id="picker-card-bg" value="#0c0020">
                                    <span class="palette-label">Card</span>
                                </div>
                                <div class="palette-item">
                                    <input type="color" id="picker-muted" value="#9e8fb2">
                                    <span class="palette-label">Muted</span>
                                </div>
                                <div class="palette-item">
                                    <input type="color" id="picker-accent" value="#ff9e2c">
                                    <span class="palette-label">Ascent</span>
                                </div>
                                <div class="palette-item">
                                    <input type="color" id="picker-accent-2" value="#ff00b8">
                                    <span class="palette-label">Height</span>
                                </div>
                                <div class="palette-item">
                                    <input type="color" id="picker-accent-3" value="#00b7ff">
                                    <span class="palette-label">Steady</span>
                                </div>
                                <div class="palette-item">
                                    <input type="color" id="picker-danger" value="#ff3333">
                                    <span class="palette-label">Ruin</span>
                                </div>
                                <div class="palette-item">
                                    <input type="color" id="picker-success" value="#00ff9d">
                                    <span class="palette-label">Summit</span>
                                </div>
                            </div>
                        </div>

                        <div class="palette-manager">
                            <span class="tiny" style="font-weight:bold;">Palette Manager</span>
                            <div class="row">
                                <select id="saved-palettes-select" style="flex:1;">
                                    <option value="">-- Select Saved --</option>
                                </select>
                            </div>
                            <div class="row">
                                <button class="btn" id="btn-load-palette" style="flex:1; font-size:9px;">Load</button>
                                <button class="btn" id="btn-delete-palette" style="flex:1; font-size:9px; color:var(--danger);">Delete</button>
                                <button class="btn" id="btn-export-palette" style="flex:1; font-size:9px;">Export</button>
                            </div>
                            <div class="row" style="margin-top:2px;">
                                <input type="text" id="palette-name-input" placeholder="Theme Name" style="flex:2;">
                                <button class="btn" id="btn-save-palette" style="flex:1; font-size:9px;">Save</button>
                            </div>
                            <button class="btn" id="btn-import-palette" style="width:100%; font-size:9px;">Import JSON</button>
                            <input type="file" id="file-import-palette" style="display:none" accept=".json">
                        </div>
                    </div>
                </details>
                
                <div class="row" style="margin-top:4px; padding-top:4px; border-top:1px solid rgba(255,255,255,0.1); justify-content: flex-end;">
                    <label class="checkbox-wrapper" style="margin-right:auto;">
                        <input type="checkbox" id="chk-reset-on-apply" checked>
                        <span>Reset</span>
                    </label>
                    <button class="btn" id="apply" style="flex:1; font-size:10px; padding:4px">Apply</button>
                    <button class="btn" id="resetState" aria-keyshortcuts="R" style="flex:1; opacity:0.8; font-size:10px; padding:4px; background:#440000; color:#ffcccc">Reset</button>
                </div>
            </div>
        </details>
      </div>

      <div class="card">
        <details>
          <summary>CONTROLS</summary>
          <div class="details-content">
            <div class="row" style="align-items: center; gap: 4px;">
              <button class="btn" id="auto" aria-keyshortcuts="A" style="flex:1; font-size:10px; padding:4px">Auto</button>
              <label class="checkbox-wrapper" for="use-delay">
                <input type="checkbox" id="use-delay">
                <span>Delay</span>
              </label>
              <select id="speed" aria-label="Auto-play speed">
                <option value="1000">Slow</option>
                <option value="100" selected>Norm</option>
                <option value="10">Fast</option>
              </select>
            </div>
            <div class="row" style="margin-top:4px">
              <input id="nRolls" type="number" value="20" aria-label="N" style="width:30px">
              <button class="btn" id="rollN" style="flex:1; font-size:9px; padding:4px">Roll N</button>
              <button class="btn" id="rollNCycles" style="flex:1; font-size:9px; padding:4px">N Attempts</button>
            </div>
            <div class="row" style="margin-top:4px">
              <span class="tiny" style="min-width:40px">Set:</span>
              <input id="set-k" type="number" min="1" value="1" style="width:30px">
              <input id="set-l" type="number" min="0" value="0" style="width:30px">
              <button class="btn" id="setStateBtn" style="padding:2px 6px; font-size:9px; flex:1">Set</button>
            </div>

            <div class="save-slots-container mode-load" id="slot-container" style="margin-top:4px">
               <div class="slot-mode-switch">
                 <button class="btn slot-mode-btn" data-mode="save">Save</button>
                 <button class="btn slot-mode-btn active" data-mode="load">Load</button>
               </div>
               <div class="slot-grid">
                 <button class="slot-btn empty" data-slot="1"><div class="slot-label">1</div><div class="slot-info">Empty</div></button>
                 <button class="slot-btn empty" data-slot="2"><div class="slot-label">2</div><div class="slot-info">Empty</div></button>
                 <button class="slot-btn empty" data-slot="3"><div class="slot-label">3</div><div class="slot-info">Empty</div></button>
                 <button class="slot-btn empty" data-slot="4"><div class="slot-label">4</div><div class="slot-info">Empty</div></button>
                 <button class="slot-btn empty" data-slot="5"><div class="slot-label">5</div><div class="slot-info">Empty</div></button>
               </div>
            </div>

            <div class="row" style="margin-top:4px; padding-top:4px; border-top:1px solid rgba(255,255,255,0.1)">
                <button class="btn" id="btn-export" style="flex:1; font-size:9px; padding:2px">Export</button>
                <button class="btn" id="btn-import" style="flex:1; font-size:9px; padding:2px">Import</button>
                <input type="file" id="file-import" style="display:none" accept=".json">
            </div>

          </div>
        </details>
      </div>

      <div class="card">
        <details>
          <summary>EXPECTATIONS</summary>
          <div class="details-content">
            <div class="row tiny" style="flex-direction:column;align-items:flex-start;gap:2px">
              <div class="space-between" style="width:100%"><span>Ascent rate:</span> <span class="mono" id="exp-win-rate">—</span></div>
              <div class="space-between" style="width:100%"><span>Ruin rate:</span> <span class="mono" id="exp-loss-rate">—</span></div>
              <div class="space-between" style="width:100%"><span>p(Asc | !Std):</span> <span id="recent-p-cond" class="mono">—</span></div>
              <div class="space-between" style="width:100%"><span>p(Sum | now):</span> <span id="recent-p-top" class="mono">—</span></div>
              <div style="width:100%; border-top:1px solid rgba(255,255,255,0.05); margin-top:2px; padding-top:2px;"></div>
              <div class="space-between" style="width:100%"><span>E[Summit] (rolls):</span> <span class="mono" id="exp-time-top">—</span></div>
              <div class="space-between" style="width:100%"><span>Opt. Asc/Hour:</span> <span class="mono" id="exp-wins-hour">—</span></div>
            </div>
          </div>
        </details>
      </div>

      <div class="card"><h2>Distributions</h2>
        <div class="tiny" style="margin-top:2px">Height</div>
        <div id="hist-k" class="tiny" style="margin-top:1px;height:40px"></div>
        <div class="tiny" style="margin-top:2px">Poise</div>
        <div id="hist-l" class="tiny" style="margin-top:1px;height:40px"></div>
        <div class="tiny" style="margin-top:2px">Heatmap</div>
        <div id="hist-kl" class="tiny" style="margin-top:1px;min-height:24px"></div>
        
        <div class="tiny" style="margin-top:6px; font-weight:600; color:var(--muted)">Durations (N=<span id="global-n">0</span>)</div>
        <div class="stats-grid" id="global-stats">
          <div class="stat-box"><div class="stat-label">Min</div><div class="stat-val" id="gs-min">—</div></div>
          <div class="stat-box"><div class="stat-label">25%</div><div class="stat-val" id="gs-25">—</div></div>
          <div class="stat-box"><div class="stat-label">Med</div><div class="stat-val" id="gs-50">—</div></div>
          <div class="stat-box"><div class="stat-label">75%</div><div class="stat-val" id="gs-75">—</div></div>
          <div class="stat-box"><div class="stat-label">Max</div><div class="stat-val" id="gs-max">—</div></div>
        </div>

        <div class="tiny" style="margin-top:4px">Last 40 Attempts</div>
        <div id="hist-cycle-len" class="tiny" style="margin-top:2px"></div>
      </div>
    </div>
  </div>
</div>

<script>

const THEMES = {
  default: {
    '--bg': '#080014', '--text': '#fef8ff', '--muted': '#9e8fb2',
    '--accent': '#ff9e2c', '--accent-2': '#ff00b8', '--accent-3': '#00b7ff',
    '--danger': '#ff3333', '--success': '#00ff9d',
    '--card-bg-color': '#0c0020',
    '--card-bg': 'rgba(12, 0, 32, 0.75)', '--card-border': 'rgba(255,255,255,0.08)',
    '--bg-image': 'radial-gradient(900px 700px at 50% -200px, rgba(255,0,200,.15), transparent 70%), radial-gradient(900px 700px at 50% 120%, rgba(0,200,255,.12), transparent 70%), linear-gradient(180deg,#0b0014 0%, #050010 100%)'
  },
  magma: {
    '--bg': '#1a0500', '--text': '#ffe0d0', '--muted': '#c47d63',
    '--accent': '#ffcc00', '--accent-2': '#ff4400', '--accent-3': '#ff8800',
    '--danger': '#ff0000', '--success': '#ffcc00',
    '--card-bg-color': '#280500',
    '--card-bg': 'rgba(40, 5, 0, 0.8)', '--card-border': 'rgba(255, 100, 0, 0.2)',
    '--bg-image': 'radial-gradient(circle at 50% 0%, rgba(255,200,0,0.2), transparent 60%), linear-gradient(0deg, #1a0500 0%, #3d0c02 100%)'
  },
  terminal: {
    '--bg': '#000000', '--text': '#00ff00', '--muted': '#008f11',
    '--accent': '#00ff00', '--accent-2': '#00cc00', '--accent-3': '#008800',
    '--danger': '#ff3333', '--success': '#00ff00',
    '--card-bg-color': '#001400',
    '--card-bg': 'rgba(0, 20, 0, 0.9)', '--card-border': 'rgba(0,255,0,0.3)',
    '--bg-image': 'linear-gradient(rgba(0, 255, 0, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 0, 0.03) 1px, transparent 1px)'
  },
  paper: {
    '--bg': '#f0f2f5', '--text': '#1a1a1a', '--muted': '#555555',
    '--accent': '#d9534f', '--accent-2': '#337ab7', '--accent-3': '#5bc0de',
    '--danger': '#d9534f', '--success': '#5cb85c',
    '--card-bg-color': '#ffffff',
    '--card-bg': 'rgba(255, 255, 255, 0.9)', '--card-border': 'rgba(0,0,0,0.1)',
    '--bg-image': 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)'
  },
  ocean: {
    '--bg': '#000814', '--text': '#e0f7ff', '--muted': '#6a8faf',
    '--accent': '#00d9ff', '--accent-2': '#0055ff', '--accent-3': '#0088ff',
    '--danger': '#ff3333', '--success': '#00ffcc',
    '--card-bg-color': '#000a1e',
    '--card-bg': 'rgba(0, 10, 30, 0.7)', '--card-border': 'rgba(0,180,255,0.1)',
    '--bg-image': 'radial-gradient(circle at 50% 100%, rgba(0,255,180,0.15), transparent 70%), linear-gradient(180deg, #000814 0%, #001a33 100%)'
  }
};

class ColorUtils {
    static Lerp(min, max, t) { return min + (max - min) * t; }

    static oklab_to_linear_srgb(L, a, b) {
      let l_ = L + 0.3963377774 * a + 0.2158037573 * b;
      let m_ = L - 0.1055613458 * a - 0.0638541728 * b;
      let s_ = L - 0.0894841775 * a - 1.2914855480 * b;
      let l = l_ * l_ * l_;
      let m = m_ * m_ * m_;
      let s = s_ * s_ * s_;
      return [
        (+4.0767416621 * l - 3.3077115913 * m + 0.2309699292 * s),
        (-1.2684380046 * l + 2.6097574011 * m - 0.3413193965 * s),
        (-0.0041960863 * l - 0.7034186147 * m + 1.7076147010 * s),
      ];
    }
    
    static oklch_to_oklab(L, c, h) {
      return [(L), (c * Math.cos(h)), (c * Math.sin(h))];
    }

    static rgbToHex(r, g, b) {
        const toHex = (n) => {
            const hex = Math.max(0, Math.min(255, Math.round(n))).toString(16);
            return hex.length === 1 ? '0' + hex : hex;
        };
        return '#' + toHex(r) + toHex(g) + toHex(b);
    }
    
    static hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }
    
    static hexToRgba(hex, alpha) {
        const rgb = this.hexToRgb(hex);
        if(!rgb) return hex;
        return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
    }
    
    static getRelativeLuminance(hex) {
        const rgb = this.hexToRgb(hex);
        if (!rgb) return 0;
        const [rs, gs, bs] = [rgb.r/255, rgb.g/255, rgb.b/255].map(c => 
            c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)
        );
        return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
    }
    
    static getContrastRatio(hex1, hex2) {
        const l1 = this.getRelativeLuminance(hex1);
        const l2 = this.getRelativeLuminance(hex2);
        return (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05);
    }
    
    static validatePalette(palette, bgColor = '#080014') {
        const issues = [];
        const minContrast = 3.0; 
        
        ['--accent', '--accent-2', '--accent-3', '--danger', '--success'].forEach(key => {
            if (palette[key]) {
                const contrast = this.getContrastRatio(palette[key], bgColor);
                if (contrast < minContrast) {
                    issues.push({ message: `${key} has low contrast` });
                }
            }
        });
        
        return { valid: issues.length === 0, issues: issues };
    }
    
    static generateOklchColor(lightness, chroma, hue) {
        const lab = this.oklch_to_oklab(lightness, chroma, hue);
        const rgb = this.oklab_to_linear_srgb(lab[0], lab[1], lab[2]);
        const r = Math.pow(Math.max(0, Math.min(rgb[0], 1)), 1/2.2) * 255;
        const g = Math.pow(Math.max(0, Math.min(rgb[1], 1)), 1/2.2) * 255;
        const b = Math.pow(Math.max(0, Math.min(rgb[2], 1)), 1/2.2) * 255;
        return this.rgbToHex(r, g, b);
    }
    
    static generateMutedColor(accentHex, bgHex) {
        const accent = this.hexToRgb(accentHex);
        const bg = this.hexToRgb(bgHex);
        if (!accent || !bg) return '#888888';
        const r = Math.round(accent.r * 0.4 + bg.r * 0.4 + 128 * 0.2);
        const g = Math.round(accent.g * 0.4 + bg.g * 0.4 + 128 * 0.2);
        const b = Math.round(accent.b * 0.4 + bg.b * 0.4 + 128 * 0.2);
        return this.rgbToHex(r, g, b);
    }
    
    static generateBgGradient(accent1, accent2, bgBase) {
        const rgb1 = this.hexToRgb(accent1);
        const rgb2 = this.hexToRgb(accent2);
        if (!rgb1 || !rgb2) return 'linear-gradient(180deg, #0b0014 0%, #050010 100%)';
        const glow1 = `rgba(${rgb1.r},${rgb1.g},${rgb1.b},.12)`;
        const glow2 = `rgba(${rgb2.r},${rgb2.g},${rgb2.b},.10)`;
        return `radial-gradient(900px 700px at 50% -200px, ${glow1}, transparent 70%), ` +
               `radial-gradient(900px 700px at 50% 120%, ${glow2}, transparent 70%), ` +
               `linear-gradient(180deg, ${bgBase} 0%, #000 100%)`;
    }
    
    static generateSemanticPalette() {
        const hueBase = Math.random() * 2 * Math.PI;
        const mood = Math.random();
        let lightnessRange = mood < 0.5 ? { min: 0.60, max: 0.85 } : { min: 0.65, max: 0.92 };
        
        const chromaBase = 0.15 + Math.random() * 0.1;
        const lightnessBase = this.Lerp(lightnessRange.min, lightnessRange.max, Math.random());
        const bgLightness = 0.05 + Math.random() * 0.05;
        const bg = this.generateOklchColor(bgLightness, 0.02, hueBase);
        
        const accent = this.generateOklchColor(lightnessBase, chromaBase, hueBase);
        const accent2 = this.generateOklchColor(lightnessBase, chromaBase, hueBase + 2);
        const accent3 = this.generateOklchColor(lightnessBase, chromaBase, hueBase + 4);
        
        const text = this.generateOklchColor(0.95, 0.01, hueBase);
        const muted = this.generateMutedColor(accent, bg);
        const bgImage = this.generateBgGradient(accent2, accent3, bg);
        
        const bgRgb = this.hexToRgb(bg);
        const cardBgColor = bgRgb ? this.rgbToHex(bgRgb.r+5, bgRgb.g+5, bgRgb.b+5) : '#0c0020';
        
        return {
            '--bg': bg, '--text': text, '--muted': muted,
            '--accent': accent, '--accent-2': accent2, '--accent-3': accent3,
            '--danger': '#ff3333', '--success': '#00ff9d',
            '--card-bg-color': cardBgColor,
            '--card-bg': ColorUtils.hexToRgba(cardBgColor, 0.75),
            '--card-border': 'rgba(255,255,255,0.08)',
            '--bg-image': bgImage
        };
    }
}

class BackgroundTimer {
  constructor() {
    const blob = new Blob([`
      const timers = new Map();
      self.onmessage = function(e) {
        const { id, type, delay } = e.data;
        if (type === 'clear') {
          const t = timers.get(id);
          if (t) { clearTimeout(t); clearInterval(t); timers.delete(id); }
        } else if (type === 'setTimeout') {
          const t = setTimeout(() => { self.postMessage({ id, type: 'timeout' }); timers.delete(id); }, delay);
          timers.set(id, t);
        } else if (type === 'setInterval') {
          const t = setInterval(() => { self.postMessage({ id, type: 'interval' }); }, delay);
          timers.set(id, t);
        }
      };
    `], { type: 'application/javascript' });
    this.worker = new Worker(URL.createObjectURL(blob));
    this.callbacks = new Map();
    this.nextId = 1;
    this.worker.onmessage = (e) => {
      const cb = this.callbacks.get(e.data.id);
      if (cb) cb();
    };
  }
  setTimeout(cb, d) {
    const id = this.nextId++; this.callbacks.set(id, cb);
    this.worker.postMessage({ id, type: 'setTimeout', delay: d });
    return id;
  }
  setInterval(cb, d) {
    const id = this.nextId++; this.callbacks.set(id, cb);
    this.worker.postMessage({ id, type: 'setInterval', delay: d });
    return id;
  }
  clear(id) {
    if (!id) return;
    this.worker.postMessage({ id, type: 'clear' });
    this.callbacks.delete(id);
  }
}

class ProbabilityCache {
  constructor(maxSize = 400) {
    this.cache = new Map();
    this.maxSize = maxSize;
    this.hits = 0; this.misses = 0;
  }
  makeKey(k, l, p) {
    return `${k},${l},${p.w_min},${p.w_max},${p.beta},${p.rho},${p.gamma},${p.c_min},${p.c_max},${p.alpha},${p.M},${p.L}`;
  }
  get(k, l, p) {
    const key = this.makeKey(k, l, p);
    const result = this.cache.get(key);
    if (result) { this.hits++; return result; }
    this.misses++; return null;
  }
  set(k, l, p, probs) {
    if (this.cache.size >= this.maxSize) this.cache.delete(this.cache.keys().next().value);
    this.cache.set(this.makeKey(k, l, p), probs);
    return probs;
  }
  clear() { this.cache.clear(); this.hits=0; this.misses=0; }
  getStats() { return { hitRate: this.hits / (this.hits + this.misses) || 0 }; }
}

class AriaAnnouncer {
  constructor() { this.element = document.getElementById('aria-announcer'); }
  announce(msg) {
    this.element.textContent = msg;
    setTimeout(() => { this.element.textContent = ''; }, 1000);
  }
}

class PerformanceMonitor {
  constructor() {
    this.frameCount = 0; this.lastTime = performance.now(); this.fps = 0;
    this.element = document.getElementById('perf-indicator');
  }
  tick() {
    this.frameCount++;
    const now = performance.now();
    const delta = now - this.lastTime;
    if (delta >= 1000) {
      this.fps = Math.round(this.frameCount * 1000 / delta);
      this.frameCount = 0; this.lastTime = now;
      this.update();
    }
  }
  update() {
    const cs = SisyphusMath.probCache.getStats();
    this.element.textContent = `FPS: ${this.fps} | Cache: ${(cs.hitRate * 100).toFixed(0)}%`;
  }
}

class SisyphusMath {
  static EPSILON = 1e-10;
  static probCache = new ProbabilityCache();
  
  static computeProbs(k, l, p) {
    const cached = this.probCache.get(k, l, p);
    if (cached) return cached;
    
    k = Math.round(k); l = Math.round(l);
    const M = Math.max(1, p.M | 0);
    const L = Math.max(1, p.L | 0);
    const frac = M > 1 ? (k - 1) / (M - 1) : 1;
    
    const base = p.w_min + (p.w_max - p.w_min) * Math.pow(frac, p.beta);
    const ell = (1 - p.rho) + p.rho * Math.pow(l / L, p.gamma);
    
    let p_win = Math.min(1, Math.max(0, base * ell));
    let p_loss = p.c_min + (p.c_max - p.c_min) * Math.exp(-p.alpha * l);
    
    const sum = p_win + p_loss;
    if (sum > 1 + this.EPSILON) { p_win /= sum; p_loss /= sum; }
    else if (sum > 1) { const scale = 1/sum; p_win *= scale; p_loss *= scale; }
    
    let p_neu = Math.max(0, 1 - p_win - p_loss);
    const total = p_win + p_neu + p_loss;
    if (Math.abs(total - 1) > this.EPSILON) { p_win/=total; p_neu/=total; p_loss/=total; }
    
    const result = { p_win, p_neu, p_loss };
    this.probCache.set(k, l, p, result);
    return result;
  }

  static getDelay(k, l, p) {
    if (p.max_delay <= 0) return 0;
    const kRatio = Math.max(0, (k - 1) / (p.M - 1 || 1));
    const lRatio = Math.max(0, l / (p.L || 1));
    const reduction = (0.8 * kRatio) + (0.2 * lRatio);
    const ms = (p.max_delay * 1000) * Math.pow(1 - Math.min(1, reduction), 3);
    if (ms < 20) return 0;
    return Math.max(100, ms); 
  }
  
  static clearCache() { this.probCache.clear(); }

  static solveExpectations(p) {
    const M = Math.max(1, p.M | 0);
    const L = Math.max(0, p.L | 0);
    const createGrid = () => Array.from({length: M + 1}, () => new Float64Array(L + 1));
    const TopHit = createGrid(); const CycleLen = createGrid(); const WinCount = createGrid(); const TimeLen = createGrid();
    
    const maxIter = 400, tol = 1e-6;
    const lossDelay = SisyphusMath.getDelay(1, 0, p) / 1000;
    const s_w = p.s_w; const g_n = p.g_n;

    for (let it = 0; it < maxIter; it++) {
      let maxDiff = 0;
      for (let k = 1; k <= M; k++) {
        for (let l = 0; l <= L; l++) {
          const {p_win, p_neu, p_loss} = SisyphusMath.computeProbs(k, l, p);
          const l_win = (l - s_w) < 0 ? 0 : (l - s_w);
          const l_neu = (l + g_n) > L ? L : (l + g_n);
          let valTop = 0, valCyc = 0, valWin = 0, valTime = 0;
          
          if (k === M) {
             valTop = p_win + p_neu * TopHit[M][l_neu];
             valCyc = 1 + p_neu * CycleLen[M][l_neu];
             valWin = p_win + p_neu * WinCount[M][l_neu];
             const delayNeu = SisyphusMath.getDelay(k, l_neu, p) / 1000;
             const stepCost = (p_neu * delayNeu) + (p_loss * lossDelay); 
             valTime = stepCost + p_neu * TimeLen[M][l_neu];
          } else {
             valTop = p_win * TopHit[k+1][l_win] + p_neu * TopHit[k][l_neu];
             valCyc = 1 + p_win * CycleLen[k+1][l_win] + p_neu * CycleLen[k][l_neu];
             valWin = p_win * (1 + WinCount[k+1][l_win]) + p_neu * WinCount[k][l_neu];
             const delayWin = SisyphusMath.getDelay(k+1, l_win, p) / 1000;
             const delayNeu = SisyphusMath.getDelay(k, l_neu, p) / 1000;
             const stepCost = (p_win * delayWin) + (p_neu * delayNeu) + (p_loss * lossDelay);
             valTime = stepCost + p_win * TimeLen[k+1][l_win] + p_neu * TimeLen[k][l_neu];
          }
          const diff = Math.abs(valTop - TopHit[k][l]);
          if(diff > maxDiff) maxDiff = diff;
          TopHit[k][l] = valTop; CycleLen[k][l] = valCyc; WinCount[k][l] = valWin; TimeLen[k][l] = valTime;
        }
      }
      if (maxDiff < tol) break;
    }
    return { TopHit, CycleLen, WinCount, TimeLen };
  }

  static getQuantiles(data) {
    if (!data || data.length === 0) return null;
    const sorted = [...data].sort((a, b) => a - b);
    const q = (p) => {
      const pos = (sorted.length - 1) * p;
      const base = Math.floor(pos);
      const rest = pos - base;
      if (sorted[base + 1] !== undefined) return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
      return sorted[base];
    };
    return { min: sorted[0], q25: q(0.25), med: q(0.50), q75: q(0.75), max: sorted[sorted.length - 1] };
  }
}

class SisyphusModel {
  constructor() {
    this.params = {
      M:20, L:20, w_min:0.10, w_max:0.90, beta:1.5, rho:0.6, gamma:1.5,
      c_min:0.03, c_max:0.10, alpha:0.3, g_n:1, s_w:20, 
      max_delay: 45.0, chaos_dt: 0.0025, chaos_intensity: 1.0
    };
    this.reset();
  }

  reset() {
    this.state = { k:1, l:0, step:0, topHit:false, cycleSteps:0 };
    this.stats = { wins:0, neus:0, loss:0, maxK:1, longestCycle:0 };
    this.historyK = [];
    this.cycleId = 1;
    this.currentCycle = this._newCycle();
    this.cycleSummaries = []; 
    this.allCycles = []; 
    this.startTime = Date.now();
    const M = Math.max(1, this.params.M);
    const L = Math.max(0, this.params.L);
    this.distributions = { 
      k: Array(M+1).fill(0), l: Array(L+1).fill(0), 
      kl: Array.from({length: M+1}, () => Array(L+1).fill(0)),
      cycles: []
    };
    this.lastRoll = null; 
  }

  _newCycle() { return { id: this.cycleId, length:0, wins:0, neus:0, maxK:this.state.k, path:'' }; }

  step() {
    if (this.state.topHit) return null;
    const k0 = this.state.k, l0 = this.state.l;
    const probs = SisyphusMath.computeProbs(k0, l0, this.params);
    const r = Math.random();
    
    let outcome = 'loss';
    let k1 = 1, l1 = 0;

    if (r < probs.p_win) {
      if (k0 === this.params.M) { outcome = 'top'; k1 = k0; l1 = l0; this.state.topHit = true; } 
      else { outcome = 'win'; k1 = Math.min(this.params.M, k0 + 1); l1 = Math.max(0, l0 - this.params.s_w); }
    } else if (r < probs.p_win + probs.p_neu) {
      outcome = 'neu'; k1 = k0; l1 = Math.min(this.params.L, l0 + this.params.g_n);
    }

    this.state.k = k1; this.state.l = l1; this.state.step++; this.state.cycleSteps++;
    
    if (outcome === 'win' || outcome === 'top') this.stats.wins++;
    else if (outcome === 'neu') this.stats.neus++;
    else if (outcome === 'loss') this.stats.loss++;

    if (outcome === 'loss' || outcome === 'top') {
      if (this.state.cycleSteps > this.stats.longestCycle) this.stats.longestCycle = this.state.cycleSteps;
      if (outcome === 'loss') this.state.cycleSteps = 0;
    }

    this.stats.maxK = Math.max(this.stats.maxK, k1);
    this.historyK.push(k1);
    if (this.historyK.length > 200) this.historyK.shift();

    this._updateCycle(outcome, k1);
    this._updateDistributions(k1, l1);

    this.lastRoll = { outcome, k0, l0, k1, l1 };
    return outcome;
  }

  _updateDistributions(k, l) {
    const d = this.distributions;
    if (d.k[k] !== undefined) d.k[k]++;
    if (d.l[l] !== undefined) d.l[l]++;
    if (d.kl[k] && d.kl[k][l] !== undefined) d.kl[k][l]++;
  }

  _updateCycle(outcome, k1) {
    const sym = { win:'+', neu:'.', loss:'X', top:'★' }[outcome];
    if (sym) {
      this.currentCycle.length++;
      if (outcome === 'win') this.currentCycle.wins++;
      if (outcome === 'neu') this.currentCycle.neus++;
      this.currentCycle.maxK = Math.max(this.currentCycle.maxK, k1);
      this.currentCycle.path += sym;
    }
    if (outcome === 'loss' || outcome === 'top') {
      this.allCycles.push(this.currentCycle.length);
      this.distributions.cycles.push(this.currentCycle.length);
      if (this.distributions.cycles.length > 40) this.distributions.cycles.shift();
      const summary = { ...this.currentCycle, outcome };
      this.cycleSummaries.unshift(summary);
      if (this.cycleSummaries.length > 7) this.cycleSummaries.pop();
      this.cycleId++;
      this.currentCycle = this._newCycle();
    }
  }

  setState(k, l) {
    this.state.k = Math.max(1, Math.min(this.params.M, k));
    this.state.l = Math.max(0, Math.min(this.params.L, l));
    this.historyK.push(this.state.k);
  }
}

class SisyphusUI {
  constructor(model) {
    this.model = model;
    this.els = {};
    this.pendingUpdates = new Map();
    this.rafId = null;
    
    ['rbar-win','rbar-neu','rbar-loss','rpct-win','rpct-neu','rpct-loss',
     'kpos-fill','kpos-text','lpos-fill','lpos-text','recent-p-cond','recent-p-top',
     'recent-outcome','recent-card',
     'bar-win','bar-neu','bar-loss','c-win','c-neu','c-loss',
     'r-win','r-neu','r-loss','run-steps','run-time','max-k',
     'cycle-box','hist-k','hist-l','hist-kl','hist-cycle-len',
     'global-n','gs-min','gs-25','gs-50','gs-75','gs-max',
     'exp-win-rate', 'exp-loss-rate', 'exp-time-top', 'exp-wins-hour',
     'btn-roll-main'
    ].forEach(id => this.els[id] = document.getElementById(id));
  }
  
  batchUpdate(elementId, property, value) {
    if (!this.pendingUpdates.has(elementId)) this.pendingUpdates.set(elementId, {});
    this.pendingUpdates.get(elementId)[property] = value;
    if (!this.rafId) this.rafId = requestAnimationFrame(() => this.flushUpdates());
  }
  
  flushUpdates() {
    this.pendingUpdates.forEach((updates, elementId) => {
      const el = this.els[elementId];
      if (!el) return;
      for (const [prop, value] of Object.entries(updates)) {
        if (prop === 'textContent') el.textContent = value;
        else if (prop === 'className') el.className = value;
        else if (prop.startsWith('style.')) el.style[prop.substring(6)] = value;
      }
    });
    this.pendingUpdates.clear();
    this.rafId = null;
  }

  log(msg) {} 

  _formatDuration(ms) {
    const s = Math.floor(ms / 1000);
    if(s < 60) return `${s}s`;
    const m = Math.floor(s / 60);
    if(m < 60) return `${m}m ${s%60}s`;
    const h = Math.floor(m / 60);
    if(h < 24) return `${h}h ${m%60}m`;
    const d = Math.floor(h / 24);
    return `${d}d ${h%24}h`;
  }

  render(grids, full = true, skipBars = false) {
    const m = this.model, s = m.state, st = m.stats;
    const lr = m.lastRoll || { outcome:null, k0:1, l0:0, k1:s.k, l1:s.l };
    const pct = x => (100 * Math.max(0, Math.min(1, x))).toFixed(1) + '%';
    const probs = SisyphusMath.computeProbs(lr.k1, lr.l1, m.params);
    
    this.batchUpdate('recent-outcome', 'textContent', lr.outcome ? (lr.outcome === 'neu' ? 'STEADY' : lr.outcome === 'loss' ? 'RUIN' : lr.outcome === 'top' ? 'SUMMIT' : 'ASCENT') : '—');
    this.batchUpdate('recent-card', 'className', 'card recent ' + (lr.outcome === 'top' ? 'win' : lr.outcome || ''));

    this.batchUpdate('rbar-win', 'style.width', pct(probs.p_win));
    this.batchUpdate('rbar-neu', 'style.width', pct(probs.p_neu));
    this.batchUpdate('rbar-loss', 'style.width', pct(probs.p_loss));
    this.batchUpdate('rpct-win', 'textContent', pct(probs.p_win));
    this.batchUpdate('rpct-neu', 'textContent', pct(probs.p_neu));
    this.batchUpdate('rpct-loss', 'textContent', pct(probs.p_loss));

    const p_cond = (probs.p_win + probs.p_loss > 0) ? probs.p_win / (probs.p_win + probs.p_loss) : 0;
    this.batchUpdate('recent-p-cond', 'textContent', (probs.p_win+probs.p_loss < 1e-9) ? '—' : pct(p_cond));

    let pTopText = '—';
    if (grids && grids.TopHit && grids.TopHit[lr.k1] && typeof grids.TopHit[lr.k1][lr.l1] === 'number') {
      const p = grids.TopHit[lr.k1][lr.l1];
      const odds = p > 0 ? 1/p : Infinity;
      if (p < 0.0001) pTopText = `1 in ${odds > 1e6 ? odds.toExponential(2) : Math.round(odds).toLocaleString()}`;
      else if (p <= 0.5) pTopText = `1 in ${Math.round(odds).toLocaleString()} (${(p*100).toFixed(2)}%)`;
      else pTopText = `${(p*100).toFixed(1)}%`;
    }
    this.batchUpdate('recent-p-top', 'textContent', pTopText);

    if (!skipBars) {
      this.batchUpdate('kpos-fill', 'style.width', pct(lr.k1 / m.params.M));
      this.batchUpdate('kpos-text', 'textContent', `${lr.k1} / ${m.params.M}`);
      this.batchUpdate('lpos-fill', 'style.width', pct(lr.l1 / m.params.L));
      this.batchUpdate('lpos-text', 'textContent', `${lr.l1} / ${m.params.L}`);
      this.batchUpdate('kpos-fill', 'style.transition', 'none');
      this.batchUpdate('lpos-fill', 'style.transition', 'none');
    }

    const tot = st.wins + st.neus + st.loss;
    this.batchUpdate('run-steps', 'textContent', s.step);
    this.batchUpdate('c-win', 'textContent', st.wins);
    this.batchUpdate('c-neu', 'textContent', st.neus);
    this.batchUpdate('c-loss', 'textContent', st.loss);
    this.batchUpdate('r-win', 'textContent', tot ? (100*st.wins/tot).toFixed(0)+'%' : '0%');
    this.batchUpdate('r-neu', 'textContent', tot ? (100*st.neus/tot).toFixed(0)+'%' : '0%');
    this.batchUpdate('r-loss', 'textContent', tot ? (100*st.loss/tot).toFixed(0)+'%' : '0%');
    
    this.batchUpdate('bar-win', 'style.width', tot ? (100*st.wins/tot)+'%' : '0%');
    this.batchUpdate('bar-neu', 'style.width', tot ? (100*st.neus/tot)+'%' : '0%');
    this.batchUpdate('bar-loss', 'style.width', tot ? (100*st.loss/tot)+'%' : '0%');
    
    this.batchUpdate('run-time', 'textContent', this._formatDuration(Math.max(0, Date.now() - m.startTime)));
    this.batchUpdate('max-k', 'textContent', st.maxK);
    
    this._renderCycles();
    if(full) { this._renderDistributions(); this._renderGlobalStats(); }
  }

  animateChange(k0, l0, k1, l1, duration, params) {
    const kFill = this.els['kpos-fill'];
    const lFill = this.els['lpos-fill'];
    const kText = this.els['kpos-text'];
    const lText = this.els['lpos-text'];
    
    const pK0 = (100 * Math.max(0, Math.min(1, k0 / params.M))).toFixed(2) + '%';
    const pL0 = (100 * Math.max(0, Math.min(1, l0 / params.L))).toFixed(2) + '%';
    const pK1 = (100 * Math.max(0, Math.min(1, k1 / params.M))).toFixed(2) + '%';
    const pL1 = (100 * Math.max(0, Math.min(1, l1 / params.L))).toFixed(2) + '%';

    kFill.classList.remove('active-motion', 'reverse-motion');
    lFill.classList.remove('active-motion', 'reverse-motion');
    kFill.style.transition = 'none'; lFill.style.transition = 'none';
    kFill.style.width = pK0; lFill.style.width = pL0;
    
    if (k0 !== k1) kText.textContent = `${k0} → ${k1} / ${params.M}`;
    if (l0 !== l1) lText.textContent = `${l0} → ${l1} / ${params.L}`;

    void kFill.offsetWidth; 

    if (duration > 100) {
        if (k0 !== k1) {
            kFill.classList.add('active-motion');
            if (k1 < k0) kFill.classList.add('reverse-motion'); 
        }
        if (l0 !== l1) {
            lFill.classList.add('active-motion');
            if (l1 < l0) lFill.classList.add('reverse-motion'); 
        }
    }

    const transitionStr = `width ${duration}ms linear`;
    kFill.style.transition = transitionStr; lFill.style.transition = transitionStr;
    kFill.style.width = pK1; lFill.style.width = pL1;
    
    setTimeout(() => {
        kFill.classList.remove('active-motion', 'reverse-motion');
        lFill.classList.remove('active-motion', 'reverse-motion');
    }, duration);
  }
  
  _renderCycles() {
    const box = this.els['cycle-box'];
    const tpl = document.getElementById('tpl-cycle-entry');
    const fragment = document.createDocumentFragment();
    const current = this.model.currentCycle;
    if (current) {
        const clone = tpl.content.cloneNode(true);
        const div = clone.querySelector('.cycle-entry');
        div.classList.add('active'); 
        clone.querySelector('.cycle-main-text').textContent = `#${current.id}: ACTIVE`;
        clone.querySelector('.cycle-meta').textContent = `L:${current.length} A:${current.wins}`;
        let wrapped = '';
        for(let i=0; i<(current.path||'').length; i+=28) wrapped += current.path.slice(i, i+28) + '\n';
        clone.querySelector('.cycle-entry-path').textContent = wrapped || '-';
        fragment.appendChild(clone);
    }
    this.model.cycleSummaries.forEach(c => {
      const clone = tpl.content.cloneNode(true);
      const div = clone.querySelector('.cycle-entry');
      div.classList.add(c.outcome === 'top' ? 'top' : 'loss');
      const outText = c.outcome === 'top' ? 'SUMMIT' : 'RUIN';
      clone.querySelector('.cycle-main-text').textContent = `#${c.id}: ${outText}`;
      clone.querySelector('.cycle-meta').textContent = `L:${c.length} A:${c.wins}`;
      let wrapped = '';
      for(let i=0; i<(c.path||'').length; i+=28) wrapped += c.path.slice(i, i+28) + '\n';
      clone.querySelector('.cycle-entry-path').textContent = wrapped || '-';
      fragment.appendChild(clone);
    });
    box.innerHTML = ''; box.appendChild(fragment);
  }

  _renderGlobalStats() {
    const ac = this.model.allCycles;
    this.els['global-n'].textContent = ac.length;
    const stats = SisyphusMath.getQuantiles(ac);
    if (stats) {
      this.els['gs-min'].textContent = stats.min;
      this.els['gs-25'].textContent = stats.q25.toFixed(1).replace('.0','');
      this.els['gs-50'].textContent = stats.med.toFixed(1).replace('.0','');
      this.els['gs-75'].textContent = stats.q75.toFixed(1).replace('.0','');
      this.els['gs-max'].textContent = stats.max;
    } else {
      ['gs-min','gs-25','gs-50','gs-75','gs-max'].forEach(id => this.els[id].textContent = '—');
    }
  }

  _renderDistributions() {
    const dist = this.model.distributions;
    const renderBar = (hostId, data) => {
      const host = this.els[hostId]; host.innerHTML = '';
      if(!data.length || !data.some(x=>x)) { host.textContent='—'; return; }
      const max = Math.max(...data.filter(n=>n));
      const wrap = document.createElement('div');
      wrap.style.cssText = 'display:flex;align-items:flex-end;gap:1px;height:100%';
      for(let i=(hostId==='hist-l'?0:1); i<data.length; i++){
        const bar = document.createElement('div');
        bar.style.cssText = `flex:1;border-radius:1px;background:linear-gradient(180deg,var(--accent-3),var(--accent));`;
        bar.style.height = (max ? 100 * (data[i]||0) / max : 0) + '%';
        wrap.appendChild(bar);
      }
      host.appendChild(wrap);
    };
    renderBar('hist-k', dist.k); renderBar('hist-l', dist.l);

    const hostCl = this.els['hist-cycle-len']; hostCl.innerHTML = '';
    if(dist.cycles.length) {
      const maxCL = Math.max(...dist.cycles);
      const wrap = document.createElement('div');
      wrap.style.cssText = 'display:flex;align-items:flex-end;gap:1px;height:24px';
      dist.cycles.forEach(len => {
        const bar = document.createElement('div');
        bar.style.cssText = 'flex:1;border-radius:1px;background:linear-gradient(180deg,var(--accent-3),var(--accent));';
        bar.style.height = (maxCL ? 100 * len / maxCL : 0) + '%';
        wrap.appendChild(bar);
      });
      hostCl.appendChild(wrap);
    } else hostCl.textContent = '—';

    const hostHM = this.els['hist-kl']; hostHM.innerHTML = '';
    const klData = dist.kl;
    let maxC = 0; klData.forEach(row => row.forEach(c => { if(c > maxC) maxC = c; }));
    
    if(maxC > 0) {
      const M = this.model.params.M;
      const L = this.model.params.L;
      const grid = document.createElement('div');
      grid.style.display = 'grid'; grid.style.gridTemplateColumns = `repeat(${M}, 1fr)`; grid.style.gap = '1px';
      const logMax = Math.log(1+maxC);
      for(let l=L; l>=0; l--) {
        for(let k=1; k<=M; k++) {
          const c = (klData[k] && klData[k][l]) || 0;
          const cell = document.createElement('div');
          const alpha = c > 0 ? (0.2 + 0.8 * (Math.log(1+c)/logMax)) : 0.05;
          cell.style.background = `var(--accent)`;
          cell.style.opacity = alpha.toFixed(3);
          cell.style.aspectRatio = '1/1'; cell.title = `(${k},${l}): ${c}`;
          grid.appendChild(cell);
        }
      }
      hostHM.appendChild(grid);
    } else hostHM.textContent = '—';
  }

  updateExpectations(grids) {
    const { TopHit, CycleLen, WinCount, TimeLen } = grids;
    const pCycleTop = TopHit[1][0];
    const c = CycleLen[1][0];
    const w = WinCount[1][0];
    const timePerCycle = TimeLen[1][0];
    const fmt = x => (100*x).toFixed(3)+'%';
    const el = id => document.getElementById(id);
    
    if(c > 0) {
      el('exp-win-rate').textContent = fmt(w/c);
      el('exp-loss-rate').textContent = fmt((1-pCycleTop)/c);
      
      if (pCycleTop > 1e-15) { 
        const expected = c / pCycleTop;
        el('exp-time-top').textContent = expected > 1e9 ? expected.toExponential(2) : expected.toFixed(0);
        if (this.model.params.max_delay <= 0) el('exp-wins-hour').textContent = "--";
        else el('exp-wins-hour').textContent = timePerCycle > 0.0001 ? ((w / timePerCycle) * 3600).toFixed(1) : "--";
      } else {
        if (pCycleTop === 0) { el('exp-time-top').textContent = '∞'; el('exp-wins-hour').textContent = '0'; }
        else {
           el('exp-time-top').textContent = (c/pCycleTop).toExponential(2);
           el('exp-wins-hour').textContent = timePerCycle > 0.0001 ? ((w / timePerCycle) * 3600).toFixed(1) : "--";
        }
      }
    }
  }
}

class ChaosEngine {
  constructor() {
    this.canvas = document.getElementById('chaosCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.statusEl = document.getElementById('weather-status-main');
    this.modEl = document.getElementById('weather-mod-val');
    
    this.SIGMA = 10; this.RHO = 28; this.BETA = 8/3; 
    
    this.x = 10 + (Math.random() - 0.5) * 2; 
    this.y = 10 + (Math.random() - 0.5) * 2; 
    this.z = 25 + (Math.random() - 0.5) * 2;

    this.MAX_POINTS = 8000;
    this.points = new Array(this.MAX_POINTS).fill(null);
    this.head = 0; 
    this.count = 0; 
    
    this.angle = 0; this.rotSpeed = 0.005; 
    this.scale = 8; this.fov = 250; this.yOffset = 20;     
    this.multiplier = 1.0; 
    this.colors = { calm: '#ff9e2c', windy: '#00b7ff', storm: '#ff3333' };

    this.dt = 0.0025;
    this.intensity = 1.0;

    this.resize();
    window.addEventListener('resize', () => this.resize());
    this.animate();
  }

  setParams(dt, intensity) {
      this.dt = dt || 0.0025;
      this.intensity = intensity || 1.0;
  }
  
  resize() {
    if (this.canvas.parentElement) {
       this.canvas.width = this.canvas.parentElement.clientWidth;
       this.canvas.height = this.canvas.parentElement.clientHeight;
    }
  }
  
  step() {
    const dx = (this.SIGMA * (this.y - this.x)) * this.dt;
    const dy = (this.x * (this.RHO - this.z) - this.y) * this.dt;
    const dz = (this.x * this.y - this.BETA * this.z) * this.dt;
    this.x += dx; this.y += dy; this.z += dz;
    return Math.sqrt(dx*dx + dy*dy + dz*dz);
  }
  
  setPalette(theme) {
     this.colors = {
         calm: theme['--accent'],
         windy: theme['--accent-3'],
         storm: theme['--danger']
     };
  }
  
  clearTrail() {
    this.points.fill(null);
    this.head = 0;
    this.count = 0;
  }

  updateWeather(velocity) {
    let rawInput = velocity * 1.333; 
    let scaledIntensity = rawInput * this.intensity;
    this.multiplier = 0.5 + (scaledIntensity * 2.0);
    
    if (this.modEl) this.modEl.textContent = this.multiplier.toFixed(2) + "x";

    let statusText = "", statusClass = "", color = "";
    if(scaledIntensity < 0.17) { 
        statusText = "CALM"; statusClass = "weather-good"; color = this.colors.calm;
    } else if (scaledIntensity < 0.37) { 
        statusText = "WINDY"; statusClass = "weather-ok"; color = this.colors.windy;
    } else { 
        statusText = "STORM"; statusClass = "weather-bad"; color = this.colors.storm;
    }

    if (this.statusEl) {
      this.statusEl.textContent = statusText;
      this.statusEl.className = "weather-status " + statusClass;
    }
    if (this.modEl) this.modEl.className = "mono " + statusClass;
    return color;
  }
  
  project(x, y, z, cx, cy) {
    const cosA = Math.cos(this.angle);
    const sinA = Math.sin(this.angle);
    const rx = x * cosA - y * sinA; 
    const ry = x * sinA + y * cosA; 
    const depth = this.fov / (this.fov + ry + 60); 
    return { x: cx + rx * this.scale * depth, y: (cy + this.yOffset) + (-(z - 25)) * this.scale * depth };
  }
  
  reset() {
    this.points.fill(null);
    this.count = 0;
    this.head = 0;
    this.x = 10 + (Math.random() - 0.5) * 2; 
    this.y = 10 + (Math.random() - 0.5) * 2; 
    this.z = 25 + (Math.random() - 0.5) * 2;
  }

  animate() {
    if (this.canvas.width === 0) return requestAnimationFrame(() => this.animate());

    const velocity = this.step();
    const color = this.updateWeather(velocity);
    
    this.points[this.head] = { x: this.x, y: this.y, z: this.z, color: color };
    this.head = (this.head + 1) % this.MAX_POINTS;
    if (this.count < this.MAX_POINTS) this.count++;
    
    this.angle += this.rotSpeed;

    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    const cx = this.canvas.width / 2;
    const cy = this.canvas.height / 2;
    
  if (this.count > 1) {
    this.ctx.lineWidth = 1.2;
    let idx = (this.count < this.MAX_POINTS) ? 0 : this.head;
    let p = this.points[idx];
    let prevProj = this.project(p.x, p.y, p.z, cx, cy);
    let currentColor = this.points[(idx + 1) % this.MAX_POINTS].color;
    
    this.ctx.beginPath();
    this.ctx.strokeStyle = currentColor;
    this.ctx.moveTo(prevProj.x, prevProj.y);
    
    for (let i = 1; i < this.count; i++) {
      idx = (idx + 1) % this.MAX_POINTS;
      p = this.points[idx];
      const proj = this.project(p.x, p.y, p.z, cx, cy);
      if (p.color !== currentColor) {
        this.ctx.stroke(); 
        this.ctx.beginPath();
        this.ctx.strokeStyle = p.color;
        this.ctx.moveTo(prevProj.x, prevProj.y); 
        currentColor = p.color;
      }
      this.ctx.lineTo(proj.x, proj.y);
      prevProj = proj;
    }
    this.ctx.stroke();
  }
    requestAnimationFrame(() => this.animate());
  }
  getModifier() { return this.multiplier; }
}

class GameController {
  constructor() {
    this.model = new SisyphusModel();
    this.ui = new SisyphusUI(this.model);
    this.chaos = new ChaosEngine();
    
    this.autoTimerId = null;
    this.bgTimer = new BackgroundTimer(); 
    this.renderReq = null;
    this.isAuto = false;
    this.controlsLocked = false;
    this.grids = null;
    this.announcer = new AriaAnnouncer();
    this.perfMonitor = new PerformanceMonitor();
    this.slotMode = 'load'; 

    setInterval(() => {
      if (this.ui) {
        const elapsed = Math.max(0, Date.now() - this.model.startTime);
        const el = document.getElementById('run-time');
        if (el) el.textContent = this.ui._formatDuration(elapsed);
      }
    }, 1000);
    
    this.bindEvents();
    this.bindKeyboard();
    this.load(); 
    this.refreshSavedPalettesList();
    
    const savedTheme = localStorage.getItem('sisyphus_theme') || 'default';
    if (savedTheme === 'custom') {
        const customColors = JSON.parse(localStorage.getItem('sisyphus_custom_colors') || '{}');
        this.applyCustomTheme(customColors);
    } else {
        this.setTheme(savedTheme);
    }

    this.recalcExpectations();
    this.ui.render(this.grids, true); 
    this.updateSlotUI();
    this.syncWeatherParams();
    
    if (!localStorage.getItem('sisyphus_welcome_seen')) {
      document.getElementById('welcome-modal').classList.add('show');
    }
  }

  bindEvents() {
    const $ = id => document.getElementById(id);
    $('roll1_big').onclick = () => this.stepManually();
    $('rollN').onclick = () => {
      const n = +$('nRolls').value || 20;
      for(let i=0; i<n; i++) { if(this.model.step() === 'top') break; }
      this.ui.render(this.grids); this.save();
    };
    $('rollNCycles').onclick = () => {
      const target = this.model.cycleId + (+$('nRolls').value || 1);
      let safety = 0;
      while(this.model.cycleId < target && safety++ < 2000000) { if(this.model.step() === 'top') break; }
      this.ui.render(this.grids); this.save();
    };
    $('auto').onclick = () => this.toggleAuto();
    $('apply').onclick = () => this.applyParams();
    $('resetState').onclick = () => this.reset();
    $('setStateBtn').onclick = () => {
      this.model.setState(+$('set-k').value||1, +$('set-l').value||0);
      this.ui.render(this.grids);
    }
    
    $('btn-summit-reset').onclick = () => {
      document.getElementById('summit-modal').classList.remove('show');
      this.reset();
    };
    $('btn-summit-close').onclick = () => {
      document.getElementById('summit-modal').classList.remove('show');
    };
    
    document.querySelectorAll('.slot-mode-btn').forEach(b => b.addEventListener('click', (e) => this.setSlotMode(e.target.dataset.mode)));
    document.querySelectorAll('.slot-btn').forEach(b => b.addEventListener('click', (e) => this.handleSlotAction(e.currentTarget.dataset.slot)));
    
    $('btn-export').onclick = () => this.exportSlot();
    $('btn-import').onclick = () => $('file-import').click();
    $('file-import').onchange = (e) => {
      if(e.target.files.length > 0) this.importToSlot(e.target.files[0]);
      e.target.value = ''; 
    };

    $('theme-select').onchange = (e) => this.setTheme(e.target.value);
    
    $('btn-random-palette').onclick = () => this.randomizePalette();
    
    // FULL 9-Color Mapping
    const colorMap = {
        'picker-bg': '--bg', 
        'picker-text': '--text', 
        'picker-card-bg': '--card-bg-color',
        'picker-muted': '--muted',
        'picker-accent': '--accent', 
        'picker-accent-2': '--accent-2', 
        'picker-accent-3': '--accent-3', 
        'picker-danger': '--danger',
        'picker-success': '--success'
    };

    Object.keys(colorMap).forEach(id => {
        const el = $(id);
        if(el) el.addEventListener('input', (e) => this.updateCustomColor(colorMap[id], e.target.value));
    });

    $('btn-save-palette').onclick = () => this.savePalette();
    $('btn-load-palette').onclick = () => this.loadPalette();
    $('btn-delete-palette').onclick = () => this.deletePalette();
    $('btn-export-palette').onclick = () => this.exportPalette();
    $('btn-import-palette').onclick = () => $('file-import-palette').click();
    $('file-import-palette').onchange = (e) => {
        if(e.target.files.length > 0) this.importPalette(e.target.files[0]);
        e.target.value = '';
    }
  }

  setTheme(name) {
      if(name === 'custom') {
          const cssVars = ['--bg','--text','--card-bg-color','--muted','--accent','--accent-2','--accent-3','--danger','--success'];
          const colors = {};
          cssVars.forEach(v => {
              const el = document.getElementById(v.replace('--', 'picker-').replace('-color',''));
              if(el) colors[v] = el.value;
          });
          this.applyCustomTheme(colors);
          return;
      }
      const theme = THEMES[name] || THEMES.default;
      const root = document.documentElement;
      Object.entries(theme).forEach(([key, val]) => {
        root.style.setProperty(key, val);
      });
      localStorage.setItem('sisyphus_theme', name);
      const sel = document.getElementById('theme-select');
      if(sel) sel.value = name;
      if(this.chaos) { this.chaos.setPalette(theme); this.chaos.clearTrail(); }
      this.syncPickersFromTheme(theme);
      this.hideContrastWarning();
  }
  
  syncPickersFromTheme(theme) {
      const map = {
          '--bg': 'picker-bg', '--text': 'picker-text', '--card-bg-color': 'picker-card-bg',
          '--muted': 'picker-muted', '--accent': 'picker-accent', '--accent-2': 'picker-accent-2',
          '--accent-3': 'picker-accent-3', '--danger': 'picker-danger', '--success': 'picker-success'
      };
      Object.keys(map).forEach(key => {
          if (theme[key]) {
              const el = document.getElementById(map[key]);
              if(el) el.value = theme[key];
          }
      });
  }

  updateCustomColor(varName, hex) {
      document.getElementById('theme-select').value = 'custom';
      const root = document.documentElement;
      root.style.setProperty(varName, hex);
      
      if (['--bg', '--accent', '--accent-2', '--accent-3'].includes(varName)) {
          const bg = getComputedStyle(root).getPropertyValue('--bg').trim();
          const acc2 = getComputedStyle(root).getPropertyValue('--accent-2').trim();
          const acc3 = getComputedStyle(root).getPropertyValue('--accent-3').trim();
          const newBgImage = ColorUtils.generateBgGradient(acc2, acc3, bg);
          root.style.setProperty('--bg-image', newBgImage);
      }
      
      if (varName === '--card-bg-color') {
          const rgba = ColorUtils.hexToRgba(hex, 0.75);
          root.style.setProperty('--card-bg', rgba);
      }
      
      this.saveCustomTheme();
      if(this.chaos) {
          const t = {
              '--accent': getComputedStyle(root).getPropertyValue('--accent').trim(),
              '--accent-3': getComputedStyle(root).getPropertyValue('--accent-3').trim(),
              '--danger': getComputedStyle(root).getPropertyValue('--danger').trim()
          };
          this.chaos.setPalette(t);
      }
      this.validateAndWarn();
  }
  
  hideContrastWarning() {
      const warning = document.getElementById('contrast-warning');
      if (warning) warning.style.display = 'none';
  }
  
  showContrastWarning(message) {
      const warning = document.getElementById('contrast-warning');
      const text = document.getElementById('contrast-warning-text');
      if (warning && text) {
          text.textContent = message;
          warning.style.display = 'block';
      }
  }
  
  validateAndWarn() {
      const root = document.documentElement;
      const style = getComputedStyle(root);
      const palette = {
          '--accent': style.getPropertyValue('--accent').trim(),
          '--accent-2': style.getPropertyValue('--accent-2').trim(),
          '--accent-3': style.getPropertyValue('--accent-3').trim(),
          '--danger': style.getPropertyValue('--danger').trim(),
          '--success': style.getPropertyValue('--success').trim()
      };
      const bg = style.getPropertyValue('--bg').trim() || '#080014';
      const validation = ColorUtils.validatePalette(palette, bg);
      if (!validation.valid && validation.issues.length > 0) {
          this.showContrastWarning(validation.issues[0].message);
      } else {
          this.hideContrastWarning();
      }
  }

  saveCustomTheme() {
      const root = document.documentElement;
      const style = getComputedStyle(root);
      let cardBgCol = style.getPropertyValue('--card-bg-color').trim();
      if (!cardBgCol || cardBgCol === '') cardBgCol = '#0c0020';

      const custom = {
          '--bg': style.getPropertyValue('--bg').trim(),
          '--text': style.getPropertyValue('--text').trim(),
          '--muted': style.getPropertyValue('--muted').trim(),
          '--accent': style.getPropertyValue('--accent').trim(),
          '--accent-2': style.getPropertyValue('--accent-2').trim(),
          '--accent-3': style.getPropertyValue('--accent-3').trim(),
          '--danger': style.getPropertyValue('--danger').trim(),
          '--success': style.getPropertyValue('--success').trim(),
          '--card-bg-color': cardBgCol,
          '--bg-image': style.getPropertyValue('--bg-image').trim()
      };
      custom['--card-bg'] = ColorUtils.hexToRgba(custom['--card-bg-color'], 0.75);
      
      localStorage.setItem('sisyphus_theme', 'custom');
      localStorage.setItem('sisyphus_custom_colors', JSON.stringify(custom));
  }
  
  applyCustomTheme(colors) {
      const root = document.documentElement;
      const def = THEMES.default;
      const allVars = ['--bg', '--text', '--muted', '--accent', '--accent-2', '--accent-3', '--danger', '--success', '--card-bg-color', '--card-bg', '--bg-image'];
      allVars.forEach(v => {
          if (colors[v]) { root.style.setProperty(v, colors[v]); } 
          else if (def[v]) { root.style.setProperty(v, def[v]); }
      });
      this.syncPickersFromTheme(colors);
      document.getElementById('theme-select').value = 'custom';
      if(this.chaos) {
          this.chaos.setPalette({
              '--accent': colors['--accent'] || def['--accent'],
              '--accent-3': colors['--accent-3'] || def['--accent-3'],
              '--danger': colors['--danger'] || def['--danger']
          });
          this.chaos.clearTrail();
      }
      this.validateAndWarn();
  }

  randomizePalette() {
      const palette = ColorUtils.generateSemanticPalette();
      this.applyCustomTheme(palette);
      this.saveCustomTheme();
  }

  // --- Palette Manager Logic ---

  getSavedPalettes() {
      try { return JSON.parse(localStorage.getItem('sisyphus_saved_palettes') || '{}'); } catch(e) { return {}; }
  }

  refreshSavedPalettesList() {
      const select = document.getElementById('saved-palettes-select');
      const saved = this.getSavedPalettes();
      select.innerHTML = '<option value="">-- Select Saved --</option>';
      Object.keys(saved).sort().forEach(name => {
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          select.appendChild(opt);
      });
  }

  savePalette() {
      const name = document.getElementById('palette-name-input').value.trim();
      if (!name) { alert("Name required"); return; }
      const customRaw = localStorage.getItem('sisyphus_custom_colors');
      if (!customRaw) { alert("No custom theme active"); return; }
      const saved = this.getSavedPalettes();
      if (saved[name] && !confirm(`Overwrite "${name}"?`)) return;
      saved[name] = JSON.parse(customRaw);
      localStorage.setItem('sisyphus_saved_palettes', JSON.stringify(saved));
      this.refreshSavedPalettesList();
  }

  loadPalette() {
      const select = document.getElementById('saved-palettes-select');
      const name = select.value;
      if (!name) return;
      const saved = this.getSavedPalettes();
      if (saved[name]) {
          this.applyCustomTheme(saved[name]);
          this.saveCustomTheme();
      }
  }

  deletePalette() {
      const select = document.getElementById('saved-palettes-select');
      const name = select.value;
      if (!name) return;
      if(confirm(`Delete "${name}"?`)) {
          const saved = this.getSavedPalettes();
          delete saved[name];
          localStorage.setItem('sisyphus_saved_palettes', JSON.stringify(saved));
          this.refreshSavedPalettesList();
          select.value = "";
      }
  }

  exportPalette() {
      const customRaw = localStorage.getItem('sisyphus_custom_colors');
      if (!customRaw) { alert("No custom theme to export."); return; }
      const data = JSON.parse(customRaw);
      const name = document.getElementById('palette-name-input').value.trim() || 'custom-theme';
      const exportObj = { name: name, type: 'sisyphus-palette', colors: data };
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${name}.json`; a.click();
      URL.revokeObjectURL(url);
  }

  importPalette(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
          try {
              const json = JSON.parse(e.target.result);
              if (json.type !== 'sisyphus-palette' || !json.colors) { alert("Invalid palette file."); return; }
              if(confirm(`Apply "${json.name || 'Imported'}"?`)) {
                  this.applyCustomTheme(json.colors);
                  this.saveCustomTheme();
                  document.getElementById('palette-name-input').value = json.name || '';
              }
          } catch(err) { console.error(err); alert("Error parsing file."); }
      };
      reader.readAsText(file);
  }

  // --- End Palette Manager Logic ---

  setSlotMode(mode) {
    this.slotMode = mode;
    const container = document.getElementById('slot-container');
    document.querySelectorAll('.slot-mode-btn').forEach(b => {
      if(b.dataset.mode === mode) b.classList.add('active'); else b.classList.remove('active');
    });
    container.classList.remove('mode-save', 'mode-load');
    container.classList.add('mode-' + mode);
  }

  handleSlotAction(slotId) {
    const key = `sisyphus_slot_${slotId}`;
    if (this.slotMode === 'save') {
      if (localStorage.getItem(key) && !confirm(`Overwrite Slot ${slotId}?`)) return;
      this.saveToSlot(slotId);
    } else {
      if (!localStorage.getItem(key)) return;
      if ((this.model.state.step > 0 || this.model.cycleId > 1) && !confirm(`Load Slot ${slotId}?`)) return;
      this.loadFromSlot(slotId);
    }
  }

  saveToSlot(id) {
    localStorage.setItem(`sisyphus_slot_${id}`, JSON.stringify(this.serialize()));
    this.updateSlotUI();
    this.announcer.announce(`Saved Slot ${id}`);
  }

  loadFromSlot(id) {
    const raw = localStorage.getItem(`sisyphus_slot_${id}`);
    if (raw) {
      this.deserialize(JSON.parse(raw));
      this.announcer.announce(`Loaded Slot ${id}`);
      this.syncUIParams();
      this.recalcExpectations();
      this.ui.render(this.grids, true);
      this.chaos.reset(); 
    }
  }
  
  exportSlot() {
    const slot = prompt("0 = Current, 1-5 = Slot");
    if (slot === null) return;
    const slotNum = parseInt(slot, 10);
    let data = null, filename = "";
    if (slotNum === 0) {
        data = this.serialize();
        filename = `sisyphus-current-${new Date().toISOString().slice(0,10)}.json`;
    } else if (slotNum >= 1 && slotNum <= 5) {
        const raw = localStorage.getItem(`sisyphus_slot_${slotNum}`);
        if (!raw) return;
        data = JSON.parse(raw);
        filename = `sisyphus-slot-${slotNum}.json`;
    } else return;
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  importToSlot(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const json = JSON.parse(e.target.result);
            const state = json.main || json;
            const slot = prompt("0 = Overwrite Current, 1-5 = Save to Slot");
            if (slot === null) return;
            const slotNum = parseInt(slot, 10);
            if (slotNum === 0) {
                 this.deserialize(state);
                 this.postLoadUpdate();
            } else if (slotNum >= 1 && slotNum <= 5) {
                localStorage.setItem(`sisyphus_slot_${slotNum}`, JSON.stringify(state));
                this.updateSlotUI();
            }
        } catch(err) { console.error(err); }
    };
    reader.readAsText(file);
  }

  postLoadUpdate() {
      this.syncUIParams();
      this.recalcExpectations();
      this.ui.render(this.grids, true);
      this.updateSlotUI();
      this.chaos.reset();
  }
  
  syncUIParams() {
      Object.keys(this.model.params).forEach(k => { 
          const el = document.getElementById(k); 
          if(el) el.value = this.model.params[k]; 
      });
      this.syncWeatherParams();
  }

  updateSlotUI() {
    for(let i=1; i<=5; i++) {
      const btn = document.querySelector(`.slot-btn[data-slot="${i}"]`);
      const raw = localStorage.getItem(`sisyphus_slot_${i}`);
      const infoDiv = btn.querySelector('.slot-info');
      if (raw) {
        btn.classList.add('has-data'); btn.classList.remove('empty');
        try {
          const d = JSON.parse(raw);
          infoDiv.textContent = `k:${d.state.k} s:${d.state.step}`;
        } catch(e) { infoDiv.textContent = "Err"; }
      } else {
        btn.classList.remove('has-data'); btn.classList.add('empty'); infoDiv.textContent = "Empty";
      }
    }
  }
  
  bindKeyboard() {
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
      const modal = document.getElementById('help-modal');
      switch(e.key) {
        case ' ': case 'Enter': e.preventDefault(); if (!modal.classList.contains('show')) this.stepManually(); break;
        case 'r': case 'R': if (!e.ctrlKey) { e.preventDefault(); this.reset(); } break;
        case 'a': case 'A': e.preventDefault(); this.toggleAuto(); break;
        case '?': e.preventDefault(); modal.classList.toggle('show'); break;
        case 'Escape': if (modal.classList.contains('show')) { e.preventDefault(); modal.classList.remove('show'); } break;
      }
    });
  }

  getDynamicDelay() {
    const base = SisyphusMath.getDelay(this.model.state.k, this.model.state.l, this.model.params);
    return base === 0 ? 0 : base * this.chaos.getModifier();
  }

  stepManually() {
    if (this.controlsLocked) return;
    if(this.isAuto) this.toggleAuto();
    const prevK = this.model.state.k;
    const prevL = this.model.state.l;
    const res = this.model.step();
    this.handleStepResult(res); 
    this.save();
    const delay = this.getDynamicDelay();
    if (res !== 'top' && delay > 50) {
      this.ui.render(this.grids, true, true); 
      this.ui.animateChange(prevK, prevL, this.model.state.k, this.model.state.l, delay, this.model.params);
      this.lockControls(delay, res);
    } else {
      this.ui.render(this.grids);
    }
  }

  lockControls(duration, outcome) {
    this.controlsLocked = true;
    const btn = document.getElementById('roll1_big');
    const mainSpan = document.getElementById('btn-roll-main');
    btn.disabled = true;
    btn.className = `btn big outcome-${outcome}`; 
    const verb = { win:'CLIMBING', loss:'FALLING', neu:'STEADY' }[outcome] || 'WAIT';
    const endTime = Date.now() + duration;
    
    const timerId = this.bgTimer.setInterval(() => {
      const remaining = endTime - Date.now();
      if (remaining <= 0) {
        this.bgTimer.clear(timerId);
        this.controlsLocked = false;
        btn.disabled = false;
        btn.className = 'btn big';
        mainSpan.textContent = "ROLL";
        this.ui.render(this.grids); 
      } else {
        mainSpan.textContent = `${verb} ${(Math.max(0, remaining)/1000).toFixed(1)}s`;
      }
    }, 50);
  }

  toggleAuto() {
    const btn = document.getElementById('auto');
    if (this.isAuto) {
      if (this.autoTimerId) { this.bgTimer.clear(this.autoTimerId); this.autoTimerId = null; }
      if (this.renderReq) { cancelAnimationFrame(this.renderReq); this.renderReq = null; }
      this.isAuto = false; btn.textContent = 'Auto';
      this.ui.render(this.grids, true);
    } else {
      this.isAuto = true; btn.textContent = 'Stop';
      let frameCount = 0;
      const renderLoop = () => {
        if(!this.isAuto) return;
        frameCount++;
        this.ui.render(this.grids, frameCount % 60 === 0);
        this.perfMonitor.tick();
        this.renderReq = requestAnimationFrame(renderLoop);
      };
      renderLoop();

      const logicLoop = () => {
        if (!this.isAuto) return;
        if (this.model.state.topHit) { this.toggleAuto(); return; }

        const res = this.model.step();
        this.handleStepResult(res);
        if (res === 'top') { this.toggleAuto(); this.ui.render(this.grids, true); return; }

        const useDelay = document.getElementById('use-delay').checked;
        let delay = useDelay ? (this.getDynamicDelay() || 50) : (+document.getElementById('speed').value || 100);
        if (!useDelay && delay < 20) for(let i=0; i<9; i++) if(!this.model.state.topHit) this.model.step();

        this.autoTimerId = this.bgTimer.setTimeout(logicLoop, delay);
      };
      logicLoop();
    }
  }

  handleStepResult(res) {
    if (res === 'top') { this.announcer.announce("Summit reached!"); this.showSummitModal(); }
    else if (res === 'win') this.announcer.announce(`Ascent! Height ${this.model.state.k}`);
    else if (res === 'loss') this.announcer.announce("Ruin. Reset.");
    else if (res === 'neu') this.announcer.announce("Steady.");
    if(res && res !== 'top') this.ui.log(`step ${this.model.state.step}: ${this.model.lastRoll.outcome.toUpperCase()}`);
  }

  showSummitModal() {
    const modal = document.getElementById('summit-modal');
    const elapsed = Math.max(0, Date.now() - this.model.startTime);
    document.getElementById('summit-duration').textContent = this.ui._formatDuration(elapsed);
    document.getElementById('summit-steps').textContent = this.model.state.step;
    document.getElementById('summit-cycles').textContent = this.model.cycleId;
    modal.classList.add('show');
  }

  applyParams(shouldReset = true) {
    const p = this.model.params;
    ['M','L','w_min','w_max','beta','rho','gamma','c_min','c_max','alpha','g_n','s_w','max_delay','chaos_dt','chaos_intensity'].forEach(k => {
      const el = document.getElementById(k); if(el) p[k] = +el.value;
    });
    SisyphusMath.clearCache();
    this.syncWeatherParams();
    const chk = document.getElementById('chk-reset-on-apply');
    if (chk) shouldReset = chk.checked;
    
    if (shouldReset) {
        this.reset();
    } else {
        this.model.state.k = Math.min(this.model.state.k, this.model.params.M);
        this.model.state.l = Math.min(this.model.state.l, this.model.params.L);
        this.recalcExpectations();
        this.ui.render(this.grids, true);
        this.save();
        this.announcer.announce("Applied");
    }
  }
  
  syncWeatherParams() {
      if(this.chaos) this.chaos.setParams(this.model.params.chaos_dt, this.model.params.chaos_intensity);
  }

  reset() {
    this.model.reset();
    this.chaos.reset(); 
    this.recalcExpectations();
    this.ui.render(this.grids, true);
    this.save();
    this.announcer.announce("Reset");
  }

  recalcExpectations() {
    this.grids = SisyphusMath.solveExpectations(this.model.params);
    this.ui.updateExpectations(this.grids);
  }

  serialize() {
    return {
      params: this.model.params, state: this.model.state, stats: this.model.stats,
      historyK: this.model.historyK, cycleSummaries: this.model.cycleSummaries,
      distributions: this.model.distributions, allCycles: this.model.allCycles,
      lastRoll: this.model.lastRoll, cycleId: this.model.cycleId,
      currentCycle: this.model.currentCycle, startTime: this.model.startTime
    };
  }

    deserialize(data) {
    Object.assign(this.model.params, data.params); Object.assign(this.model.state, data.state);
    Object.assign(this.model.stats, data.stats);
    if(data.historyK) this.model.historyK = data.historyK;
    if(data.cycleSummaries) this.model.cycleSummaries = data.cycleSummaries;
    if(data.distributions) this.model.distributions = data.distributions;
    if(data.allCycles) this.model.allCycles = data.allCycles;
    if(data.lastRoll) this.model.lastRoll = data.lastRoll;
    if(data.cycleId) this.model.cycleId = data.cycleId;
    if(data.currentCycle) this.model.currentCycle = data.currentCycle;
    if(data.startTime) this.model.startTime = data.startTime;
    else this.model.startTime = Date.now();
  }

  save() {
    localStorage.setItem('sisyphus_v9_delay', JSON.stringify(this.serialize()));
  }

  load() {
    try {
      const raw = localStorage.getItem('sisyphus_v9_delay'); 
      if(raw) {
        this.deserialize(JSON.parse(raw));
        this.syncUIParams();
      }
    } catch(e) { console.warn("Load failed", e); }
  }
}

document.addEventListener('DOMContentLoaded', () => { window.game = new GameController(); });

</script>
</body>
</html>
